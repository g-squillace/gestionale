---
export const prerender = false;
import Layout from '../layouts/Layout.astro';
---

<Layout title="Admin">
  <div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold text-slate-800">Pannello Admin</h1>
    <div class="flex gap-2">
      <button id="btn-export" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700">
        Esporta JSON
      </button>
      <label class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer">
        Importa JSON
        <input type="file" id="import-file" accept=".json" class="hidden" />
      </label>
    </div>
  </div>

  <!-- Tabs -->
  <div class="bg-white rounded-xl shadow-md overflow-hidden">
    <div class="flex border-b overflow-x-auto">
      <button class="tab-btn px-6 py-4 font-medium text-slate-600 hover:bg-slate-50 border-b-2 border-transparent data-[active=true]:border-blue-500 data-[active=true]:text-blue-600" data-tab="patch" data-active="true">
        Patch
      </button>
      <button class="tab-btn px-6 py-4 font-medium text-slate-600 hover:bg-slate-50 border-b-2 border-transparent data-[active=true]:border-blue-500 data-[active=true]:text-blue-600" data-tab="maglie">
        Maglie
      </button>
      <button class="tab-btn px-6 py-4 font-medium text-slate-600 hover:bg-slate-50 border-b-2 border-transparent data-[active=true]:border-blue-500 data-[active=true]:text-blue-600" data-tab="tute">
        Tute
      </button>
      <button class="tab-btn px-6 py-4 font-medium text-slate-600 hover:bg-slate-50 border-b-2 border-transparent data-[active=true]:border-blue-500 data-[active=true]:text-blue-600" data-tab="vendite">
        Vendite
      </button>
      <button class="tab-btn px-6 py-4 font-medium text-slate-600 hover:bg-slate-50 border-b-2 border-transparent data-[active=true]:border-blue-500 data-[active=true]:text-blue-600" data-tab="richieste">
        Richieste
      </button>
    </div>

    <!-- Content -->
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 id="section-title" class="text-xl font-semibold text-slate-700">Patch</h2>
        <button id="btn-add" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          Aggiungi
        </button>
      </div>

      <!-- Filtro ricerca -->
      <div class="mb-4">
        <div class="relative max-w-md">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input
            type="text"
            id="search-input"
            placeholder="Cerca per nome..."
            class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>
      </div>

      <!-- Table container -->
      <div id="table-container" class="overflow-x-auto">
        <p class="text-gray-500">Caricamento...</p>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center p-6 border-b">
        <h3 id="modal-title" class="text-xl font-semibold text-slate-800">Modifica</h3>
        <button id="btn-close-modal" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form id="edit-form" class="p-6 space-y-4">
        <!-- Form fields populated by JS -->
      </form>
      <div class="flex justify-end gap-3 p-6 border-t">
        <button type="button" id="btn-cancel" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
          Annulla
        </button>
        <button type="submit" form="edit-form" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          Salva
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300">
    <span id="toast-message"></span>
  </div>
</Layout>

<script>
  // Definizione campi per ogni collezione
  const fields: Record<string, Array<{key: string, label: string, type: string, options?: string[]}>> = {
    patch: [
      { key: 'prodotto', label: 'Prodotto', type: 'text' },
      { key: 'lotto', label: 'Lotto/Ordine', type: 'text' },
      { key: 'inMagazzino', label: 'In Magazzino', type: 'number' },
      { key: 'venduti', label: 'Venduti', type: 'number' },
      { key: 'quantitaIniziale', label: 'Quantita Iniziale', type: 'number' },
      { key: 'costoTotale', label: 'Costo Totale', type: 'number' },
      { key: 'costoUnitario', label: 'Costo Unitario', type: 'number' },
      { key: 'ricavoVendite', label: 'Ricavo Vendite', type: 'number' },
      { key: 'profitto', label: 'Profitto', type: 'number' },
    ],
    maglie: [
      { key: 'maglia', label: 'Squadra', type: 'text' },
      { key: 'stagione', label: 'Stagione', type: 'text' },
      { key: 'patches', label: 'Patches', type: 'patches' },
      { key: 'stato', label: 'Stato', type: 'select', options: ['Da preparare', 'Da arrivare', 'In magazzino', 'Venduta'] },
      { key: 'costoTotale', label: 'Costo Totale', type: 'number' },
      { key: 'costoMaglia', label: 'Costo Maglia', type: 'number' },
      { key: 'costoPatch', label: 'Costo Patch', type: 'number' },
      { key: 'prezzoVendita', label: 'Prezzo Vendita', type: 'number' },
      { key: 'profitto', label: 'Profitto', type: 'number' },
    ],
    tute: [
      { key: 'tipo', label: 'Tipo', type: 'text' },
      { key: 'squadra', label: 'Squadra', type: 'text' },
      { key: 'categoria', label: 'Categoria', type: 'text' },
      { key: 'stagione', label: 'Stagione', type: 'text' },
      { key: 'descrizione', label: 'Descrizione', type: 'text' },
      { key: 'costo', label: 'Costo', type: 'number' },
      { key: 'prezzoVendita', label: 'Prezzo Vendita', type: 'number' },
      { key: 'stato', label: 'Stato', type: 'select', options: ['In magazzino', 'Venduto'] },
      { key: 'profitto', label: 'Profitto', type: 'number' },
    ],
    vendite: [
      { key: 'data', label: 'Data', type: 'date' },
      { key: 'categoria', label: 'Categoria', type: 'select', options: ['Patch', 'Tuta', 'Maglia'] },
      { key: 'prodotto', label: 'Prodotto', type: 'product_select' },
      { key: 'quantita', label: 'Quantita', type: 'number' },
      { key: 'totale', label: 'Totale', type: 'number' },
      { key: 'piattaforma', label: 'Piattaforma', type: 'select', options: ['Vinted', 'Ebay', 'Altro'] },
      { key: 'cliente', label: 'Cliente', type: 'text' },
    ],
    vendite_new: [
      { key: 'data', label: 'Data', type: 'date' },
      { key: 'piattaforma', label: 'Piattaforma', type: 'select', options: ['Vinted', 'Ebay', 'Altro'] },
      { key: 'cliente', label: 'Cliente', type: 'text' },
      { key: 'prodotti', label: 'Prodotti', type: 'multi_products' },
    ],
    richieste: [
      { key: 'dataRichiesta', label: 'Data Richiesta', type: 'date' },
      { key: 'url', label: 'URL', type: 'text' },
      { key: 'cliente', label: 'Cliente', type: 'text' },
      { key: 'categoria', label: 'Categoria', type: 'select', options: ['Patch', 'Tuta', 'Maglia'] },
      { key: 'descrizione', label: 'Descrizione', type: 'text' },
      { key: 'budget', label: 'Budget', type: 'number' },
      { key: 'stato', label: 'Stato', type: 'select', options: ['In attesa', 'Completata', 'Annullata'] },
    ],
  };

  let data: any = {};
  let currentTab = 'patch';
  let editingIndex = -1;
  let sortField = 'data';
  let sortDirection: 'asc' | 'desc' = 'desc';

  // Colori per categoria (come nella dashboard)
  const categoryColors: Record<string, { bg: string, text: string, dot: string }> = {
    'Patch': { bg: 'bg-blue-100', text: 'text-blue-800', dot: 'bg-blue-500' },
    'Maglia': { bg: 'bg-amber-100', text: 'text-amber-800', dot: 'bg-amber-500' },
    'Tuta': { bg: 'bg-purple-100', text: 'text-purple-800', dot: 'bg-purple-500' },
  };

  // Colori per stato maglie/tute
  const statusColors: Record<string, { bg: string, text: string }> = {
    'Da preparare': { bg: 'bg-orange-100', text: 'text-orange-800' },
    'Da arrivare': { bg: 'bg-yellow-100', text: 'text-yellow-800' },
    'In magazzino': { bg: 'bg-blue-100', text: 'text-blue-800' },
    'Venduta': { bg: 'bg-green-100', text: 'text-green-800' },
    'Venduto': { bg: 'bg-green-100', text: 'text-green-800' },
    'Da fare': { bg: 'bg-orange-100', text: 'text-orange-800' },
  };

  // Elementi DOM
  const tableContainer = document.getElementById('table-container')!;
  const sectionTitle = document.getElementById('section-title')!;
  const modal = document.getElementById('modal')!;
  const modalTitle = document.getElementById('modal-title')!;
  const editForm = document.getElementById('edit-form')!;
  const toast = document.getElementById('toast')!;
  const toastMessage = document.getElementById('toast-message')!;

  // Carica dati
  async function loadData() {
    const res = await fetch('/api/data');
    data = await res.json();
    renderTable();
  }

  // Mostra toast
  function showToast(message: string, type: 'success' | 'error' = 'success') {
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 ${
      type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
    }`;
    toastMessage.textContent = message;
    toast.classList.remove('translate-y-20', 'opacity-0');
    setTimeout(() => {
      toast.classList.add('translate-y-20', 'opacity-0');
    }, 3000);
  }

  // Render tabella
  function renderTable() {
    let items = [...(data[currentTab] || [])];
    const cols = fields[currentTab];

    if (items.length === 0) {
      tableContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Nessun elemento trovato</p>';
      return;
    }

    // Ordinamento per patch: lotto 2 prima, poi lotto 1, zero stock in fondo
    if (currentTab === 'patch') {
      items.sort((a: any, b: any) => {
        const aStock = (a.quantitaIniziale || 0) - (a.venduti || 0);
        const bStock = (b.quantitaIniziale || 0) - (b.venduti || 0);

        // Zero stock in fondo
        if (aStock === 0 && bStock > 0) return 1;
        if (bStock === 0 && aStock > 0) return -1;

        // Lotto 2 prima di Lotto 1
        const aLotto = parseInt(a.lotto) || 0;
        const bLotto = parseInt(b.lotto) || 0;
        return bLotto - aLotto;
      });
    }

    // Ordinamento per maglie/tute: in magazzino prima, vendute in fondo
    if (currentTab === 'maglie') {
      const statoOrder: Record<string, number> = { 'Da preparare': 1, 'Da arrivare': 2, 'In magazzino': 3, 'Venduta': 4 };
      items.sort((a: any, b: any) => (statoOrder[a.stato] || 5) - (statoOrder[b.stato] || 5));
    }

    if (currentTab === 'tute') {
      items.sort((a: any, b: any) => {
        if (a.stato === 'Venduto' && b.stato !== 'Venduto') return 1;
        if (b.stato === 'Venduto' && a.stato !== 'Venduto') return -1;
        return 0;
      });
    }

    // Ordinamento per la tab vendite
    if (currentTab === 'vendite') {
      items.sort((a: any, b: any) => {
        let valA = a[sortField];
        let valB = b[sortField];

        if (sortField === 'data') {
          valA = new Date(valA).getTime();
          valB = new Date(valB).getTime();
        } else {
          valA = String(valA).toLowerCase();
          valB = String(valB).toLowerCase();
        }

        if (sortDirection === 'asc') {
          return valA > valB ? 1 : -1;
        } else {
          return valA < valB ? 1 : -1;
        }
      });
    }

    // Mappa gli indici originali per edit/delete
    const originalIndices = items.map((item: any) => data[currentTab].indexOf(item));

    const displayCols = cols.slice(0, 5); // Mostra prime 5 colonne

    // Mostra colonna icona per ogni tab
    const showIconColumn = true;

    // Header con controlli di ordinamento per vendite
    const getSortIcon = (field: string) => {
      if (sortField !== field) return '<svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>';
      if (sortDirection === 'asc') return '<svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>';
      return '<svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>';
    };

    const sortableFields = ['data', 'categoria', 'prodotto'];

    // Icone per ogni categoria
    const getIconHtml = (tab: string, categoria?: string) => {
      if (tab === 'vendite' && categoria) {
        if (categoria === 'Patch') return '<div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center"><svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg></div>';
        if (categoria === 'Maglia') return '<div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center"><svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg></div>';
        if (categoria === 'Tuta') return '<div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center"><svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" /></svg></div>';
      }
      if (tab === 'patch') return '<div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center"><svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg></div>';
      if (tab === 'maglie') return '<div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center"><svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg></div>';
      if (tab === 'tute') return '<div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center"><svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" /></svg></div>';
      if (tab === 'richieste') return '<div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center"><svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>';
      return '<div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center"><svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg></div>';
    };

    let html = `
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b text-left text-gray-500">
            ${showIconColumn ? '<th class="pb-3 pr-4"></th>' : ''}
            ${displayCols.map(col => {
              if (currentTab === 'vendite' && sortableFields.includes(col.key)) {
                return `<th class="pb-3 pr-4">
                  <button class="sort-btn flex items-center gap-1 hover:text-blue-600 transition-colors" data-field="${col.key}">
                    ${col.label}
                    ${getSortIcon(col.key)}
                  </button>
                </th>`;
              }
              return `<th class="pb-3 pr-4">${col.label}</th>`;
            }).join('')}
            <th class="pb-3 text-right">Azioni</th>
          </tr>
        </thead>
        <tbody>
    `;

    items.forEach((item: any, i: number) => {
      const originalIndex = originalIndices[i];
      // Determina il nome per la ricerca
      const searchName = (item.prodotto || item.maglia || item.tipo || item.descrizione || '').toLowerCase();
      html += `<tr class="border-b last:border-0 hover:bg-gray-50 data-row" data-name="${searchName}">`;

      // Mostra icona per ogni riga
      if (showIconColumn) {
        html += `<td class="py-3 pr-4">${getIconHtml(currentTab, item.categoria)}</td>`;
      }

      displayCols.forEach(col => {
        let value = item[col.key];
        // Mostra categoria con pallino colorato
        if (col.key === 'categoria' && categoryColors[value]) {
          const colors = categoryColors[value];
          html += `<td class="py-3 pr-4">
            <span class="inline-flex items-center gap-2 px-2 py-1 rounded ${colors.bg} ${colors.text} text-xs font-medium">
              <span class="w-2 h-2 rounded-full ${colors.dot}"></span>
              ${value}
            </span>
          </td>`;
          return;
        }
        // Mostra stato con badge colorato
        if (col.key === 'stato' && statusColors[value]) {
          const colors = statusColors[value];
          html += `<td class="py-3 pr-4">
            <span class="px-3 py-1 rounded-full ${colors.bg} ${colors.text} text-xs font-medium">
              ${value}
            </span>
          </td>`;
          return;
        }
        // Mostra patches come tag
        if (col.type === 'patches') {
          const patches = Array.isArray(value) ? value : [];
          if (patches.length > 0) {
            html += `<td class="py-3 pr-4">
              <div class="flex flex-wrap gap-1 max-w-[200px]">
                ${patches.map((p: string) => `
                  <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 text-xs rounded-md border border-blue-200">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                    ${p}
                  </span>
                `).join('')}
              </div>
            </td>`;
          } else {
            html += `<td class="py-3 pr-4"><span class="text-gray-400 text-xs">Nessuna patch</span></td>`;
          }
          return;
        }
        if (Array.isArray(value)) value = value.join(', ');
        if (value === null || value === undefined) value = '-';
        if (typeof value === 'number') value = col.key.includes('costo') || col.key.includes('prezzo') || col.key.includes('profitto') || col.key.includes('totale') || col.key.includes('ricavo') || col.key.includes('budget')
          ? value.toFixed(2) + ' EUR'
          : value;
        html += `<td class="py-3 pr-4">${value}</td>`;
      });
      html += `
        <td class="py-3 text-right">
          <button class="btn-edit p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" data-index="${originalIndex}" title="Modifica">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </button>
          <button class="btn-delete p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" data-index="${originalIndex}" title="Elimina">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </td>
      </tr>`;
    });

    html += '</tbody></table>';
    tableContainer.innerHTML = html;

    // Event listeners per edit/delete
    document.querySelectorAll('.btn-edit').forEach(btn => {
      btn.addEventListener('click', () => openModal(parseInt(btn.getAttribute('data-index')!)));
    });
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', () => deleteItem(parseInt(btn.getAttribute('data-index')!)));
    });

    // Event listeners per ordinamento
    document.querySelectorAll('.sort-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const field = btn.getAttribute('data-field')!;
        if (sortField === field) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortField = field;
          sortDirection = field === 'data' ? 'desc' : 'asc';
        }
        renderTable();
      });
    });
  }

  // Calcola costo patch per maglie
  function calcolaCostiMaglia() {
    if (currentTab !== 'maglie') return;

    const checkboxes = document.querySelectorAll<HTMLInputElement>('input[name="patch_select"]:checked');
    let costoPatch = 0;

    checkboxes.forEach(cb => {
      // Prendi il costo direttamente dal data attribute
      const costo = parseFloat(cb.getAttribute('data-costo') || '0');
      costoPatch += costo;
    });

    const costoMagliaInput = document.querySelector<HTMLInputElement>('input[name="costoMaglia"]');
    const costoPatchInput = document.querySelector<HTMLInputElement>('input[name="costoPatch"]');
    const costoTotaleInput = document.querySelector<HTMLInputElement>('input[name="costoTotale"]');

    if (costoPatchInput) costoPatchInput.value = costoPatch.toFixed(2);
    if (costoTotaleInput && costoMagliaInput) {
      const costoMaglia = parseFloat(costoMagliaInput.value) || 0;
      costoTotaleInput.value = (costoMaglia + costoPatch).toFixed(2);
    }
  }

  // Apri modal
  function openModal(index = -1) {
    editingIndex = index;
    // Per nuove vendite usa il form multi-prodotto
    const colsKey = (currentTab === 'vendite' && index < 0) ? 'vendite_new' : currentTab;
    const cols = fields[colsKey];
    const item = index >= 0 ? data[currentTab][index] : {};

    modalTitle.textContent = index >= 0 ? 'Modifica elemento' : 'Aggiungi elemento';

    let formHtml = '';
    cols.forEach(col => {
      let value = item[col.key];
      if (Array.isArray(value)) value = value.join(', ');
      value = value ?? '';

      // Gestione speciale per patches nelle maglie
      if (col.type === 'patches') {
        const selectedPatches = item.patches || [];
        const selectedPatchIds = item.patch_ids || [];
        // Filtra solo patch con disponibilità > 0
        const availablePatches = data.patch.filter((p: any) => {
          const disp = p.inMagazzino ?? (p.quantitaIniziale - p.venduti);
          // Mostra se ha disponibilità O se è già selezionata per questa maglia
          return disp > 0 || selectedPatchIds.includes(p.id) || selectedPatches.includes(p.prodotto);
        });
        formHtml += `
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">${col.label}</label>
            <div class="space-y-2 p-3 border border-gray-200 rounded-lg bg-gray-50 max-h-60 overflow-y-auto">
              ${availablePatches.map((p: any) => {
                const lottoLabel = p.lotto ? ` [${p.lotto}]` : '';
                const disp = p.inMagazzino ?? (p.quantitaIniziale - p.venduti);
                const isSelected = selectedPatchIds.includes(p.id) || selectedPatches.includes(p.prodotto);
                return `
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded">
                  <input
                    type="checkbox"
                    name="patch_select"
                    value="${p.id}"
                    data-costo="${p.costoUnitario}"
                    data-nome="${p.prodotto}${lottoLabel}"
                    ${isSelected ? 'checked' : ''}
                    class="patch-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                  />
                  <span class="text-sm">${p.prodotto}${lottoLabel}</span>
                  <span class="text-xs text-gray-500">(${p.costoUnitario.toFixed(2)}€ - ${disp} disp.)</span>
                </label>
              `}).join('')}
            </div>
            <input type="hidden" name="patches" />
            <input type="hidden" name="patch_ids" />
          </div>
        `;
      } else if (currentTab === 'maglie' && (col.key === 'costoPatch' || col.key === 'costoTotale')) {
        // Campi di sola lettura calcolati automaticamente
        formHtml += `
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">${col.label} <span class="text-xs text-blue-600">(calcolato automaticamente)</span></label>
            <input
              type="number"
              name="${col.key}"
              value="${value}"
              step="0.01"
              readonly
              class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-100 text-gray-600"
            />
          </div>
        `;
      } else if (col.type === 'multi_products') {
        // Form speciale per vendite multiple
        formHtml += `
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">${col.label}</label>
            <div id="products-container" class="space-y-3">
              <div class="product-row flex gap-2 items-end p-3 bg-gray-50 rounded-lg">
                <div class="flex-1">
                  <label class="block text-xs text-gray-500 mb-1">Categoria</label>
                  <select name="prod_categoria[]" class="prod-categoria w-full border border-gray-300 rounded px-2 py-1.5 text-sm">
                    <option value="Patch">Patch</option>
                    <option value="Tuta">Tuta</option>
                    <option value="Maglia">Maglia</option>
                  </select>
                </div>
                <div class="flex-[2]">
                  <label class="block text-xs text-gray-500 mb-1">Prodotto</label>
                  <select name="prod_prodotto[]" class="prod-prodotto w-full border border-gray-300 rounded px-2 py-1.5 text-sm">
                    ${data.patch.filter((p: any) => {
                      const disp = p.inMagazzino ?? (p.quantitaIniziale - p.venduti);
                      return disp > 0;
                    }).map((p: any) => {
                      const lottoLabel = p.lotto ? ` [${p.lotto}]` : '';
                      const disp = p.inMagazzino ?? (p.quantitaIniziale - p.venduti);
                      return `<option value="${p.id}">${p.prodotto}${lottoLabel} (${disp} disp. - ${p.costoUnitario}€)</option>`;
                    }).join('')}
                  </select>
                </div>
                <div class="w-20">
                  <label class="block text-xs text-gray-500 mb-1">Qtà</label>
                  <input type="number" name="prod_quantita[]" value="1" min="1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" />
                </div>
                <div class="w-24">
                  <label class="block text-xs text-gray-500 mb-1">Prezzo €</label>
                  <input type="number" name="prod_totale[]" step="0.01" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" />
                </div>
                <button type="button" class="btn-remove-product p-1.5 text-red-500 hover:bg-red-50 rounded hidden">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>
            <button type="button" id="btn-add-product" class="mt-3 px-3 py-1.5 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Aggiungi prodotto
            </button>
          </div>
        `;
      } else if (col.type === 'product_select') {
        // Dropdown prodotti per vendite esistenti
        const categoria = item.categoria || 'Patch';
        let productOptions = '';

        if (categoria === 'Patch') {
          // Filtra patch con disponibilità > 0, ma includi sempre quella attualmente selezionata
          productOptions = data.patch.filter((p: any) => {
            const disp = p.inMagazzino ?? (p.quantitaIniziale - p.venduti);
            const isSelected = value === p.prodotto || value === `${p.prodotto} [${p.lotto}]` || (item.prodotto_id && item.prodotto_id == p.id);
            return disp > 0 || isSelected;
          }).map((p: any) => {
            const lottoLabel = p.lotto ? ` [${p.lotto}]` : '';
            const disp = p.inMagazzino ?? (p.quantitaIniziale - p.venduti);
            const selected = value === p.prodotto || value === `${p.prodotto} [${p.lotto}]` || (item.prodotto_id && item.prodotto_id == p.id) ? 'selected' : '';
            return `<option value="${p.id}" ${selected}>${p.prodotto}${lottoLabel} (${disp} disp.)</option>`;
          }).join('');
        } else if (categoria === 'Tuta') {
          // Filtra tute disponibili, ma includi sempre quella attualmente selezionata
          const currentTuta = data.tute.find((t: any) => {
            const nome = `${t.tipo} ${t.squadra} ${t.stagione}`;
            return value === nome || value?.includes(t.squadra);
          });
          const currentTutaId = currentTuta?.id;
          productOptions = data.tute.filter((t: any) => {
            return t.stato === 'In magazzino' || t.id === currentTutaId;
          }).map((t: any) => {
            const nome = `${t.tipo} ${t.squadra} ${t.stagione}`;
            const selected = t.id === currentTutaId ? 'selected' : '';
            return `<option value="${t.id}" ${selected}>${nome} [${t.stato}]</option>`;
          }).join('');
        } else if (categoria === 'Maglia') {
          // Filtra maglie disponibili, ma includi sempre quella attualmente selezionata
          // Cerca l'ID della maglia attualmente selezionata
          const currentMaglia = data.maglie.find((m: any) => {
            const nome = `${m.maglia} ${m.stagione}`;
            return value === nome || value?.includes(m.maglia);
          });
          const currentId = currentMaglia?.id;
          productOptions = data.maglie.filter((m: any) => {
            return m.stato === 'In magazzino' || m.id === currentId;
          }).map((m: any) => {
            const nome = `${m.maglia} ${m.stagione}`;
            const selected = m.id === currentId ? 'selected' : '';
            return `<option value="${m.id}" ${selected}>${nome} [${m.stato}]</option>`;
          }).join('');
        }

        formHtml += `
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">${col.label}</label>
            <select name="${col.key}" id="edit-prodotto-select" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              ${productOptions || '<option value="">Nessun prodotto</option>'}
            </select>
          </div>
        `;
      } else if (col.type === 'select') {
        formHtml += `
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">${col.label}</label>
            <select name="${col.key}" ${col.key === 'categoria' && currentTab === 'vendite' ? 'id="edit-categoria-select"' : ''} class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              ${col.options!.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
            </select>
          </div>
        `;
      } else {
        formHtml += `
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">${col.label}</label>
            <input
              type="${col.type}"
              name="${col.key}"
              value="${value}"
              ${col.type === 'number' ? 'step="0.01"' : ''}
              class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
        `;
      }
    });

    editForm.innerHTML = formHtml;
    modal.classList.remove('hidden');
    modal.classList.add('flex');

    // Aggiungi event listeners per calcolo automatico nelle maglie
    if (currentTab === 'maglie') {
      document.querySelectorAll('.patch-checkbox').forEach(cb => {
        cb.addEventListener('change', calcolaCostiMaglia);
      });
      const costoMagliaInput = document.querySelector<HTMLInputElement>('input[name="costoMaglia"]');
      if (costoMagliaInput) {
        costoMagliaInput.addEventListener('input', calcolaCostiMaglia);
      }
      // Calcola iniziale
      calcolaCostiMaglia();
    }

    // Event listeners per vendite multiple
    if (currentTab === 'vendite' && index < 0) {
      setupMultiProductsForm();
    }

    // Event listener per cambio categoria in edit vendite
    if (currentTab === 'vendite' && index >= 0) {
      const categoriaSelect = document.getElementById('edit-categoria-select') as HTMLSelectElement;
      const prodottoSelect = document.getElementById('edit-prodotto-select') as HTMLSelectElement;

      if (categoriaSelect && prodottoSelect) {
        categoriaSelect.addEventListener('change', () => {
          const cat = categoriaSelect.value;
          let options = '';

          if (cat === 'Patch') {
            // Filtra solo patch con disponibilità > 0
            options = data.patch.filter((p: any) => {
              const disp = p.inMagazzino ?? (p.quantitaIniziale - p.venduti);
              return disp > 0;
            }).map((p: any) => {
              const lottoLabel = p.lotto ? ` [${p.lotto}]` : '';
              const disp = p.inMagazzino ?? (p.quantitaIniziale - p.venduti);
              return `<option value="${p.id}">${p.prodotto}${lottoLabel} (${disp} disp.)</option>`;
            }).join('');
          } else if (cat === 'Tuta') {
            options = data.tute.map((t: any) => {
              const nome = `${t.tipo} ${t.squadra} ${t.stagione}`;
              return `<option value="${nome}">${nome} [${t.stato}]</option>`;
            }).join('');
          } else if (cat === 'Maglia') {
            options = data.maglie.map((m: any) => {
              const nome = `${m.maglia} ${m.stagione}`;
              return `<option value="${nome}">${nome} [${m.stato}]</option>`;
            }).join('');
          }

          prodottoSelect.innerHTML = options || '<option value="">Nessun prodotto</option>';
        });
      }
    }
  }

  // Setup form prodotti multipli per vendite
  function setupMultiProductsForm() {
    const container = document.getElementById('products-container');
    const btnAdd = document.getElementById('btn-add-product');

    if (!container || !btnAdd) return;

    // Aggiorna dropdown prodotti quando cambia categoria
    function updateProductDropdown(row: Element) {
      const catSelect = row.querySelector('.prod-categoria') as HTMLSelectElement;
      const prodSelect = row.querySelector('.prod-prodotto') as HTMLSelectElement;

      if (!catSelect || !prodSelect) return;

      const categoria = catSelect.value;
      let options = '';

      if (categoria === 'Patch') {
        // Filtra solo patch con disponibilità > 0
        const disponibili = data.patch.filter((p: any) => {
          const disp = p.inMagazzino ?? (p.quantitaIniziale - p.venduti);
          return disp > 0;
        });
        options = disponibili.map((p: any) => {
          const lottoLabel = p.lotto ? ` [${p.lotto}]` : '';
          const disp = p.inMagazzino ?? (p.quantitaIniziale - p.venduti);
          return `<option value="${p.id}">${p.prodotto}${lottoLabel} (${disp} disp. - ${p.costoUnitario}€)</option>`;
        }).join('');
      } else if (categoria === 'Tuta') {
        const disponibili = data.tute.filter((t: any) => t.stato === 'In magazzino');
        options = disponibili.map((t: any) => `<option value="${t.id}">${t.tipo} ${t.squadra} ${t.stagione}</option>`).join('');
      } else if (categoria === 'Maglia') {
        const disponibili = data.maglie.filter((m: any) => m.stato === 'In magazzino');
        options = disponibili.map((m: any) => `<option value="${m.id}">${m.maglia} ${m.stagione}</option>`).join('');
      }

      prodSelect.innerHTML = options || '<option value="">Nessun prodotto disponibile</option>';
    }

    // Aggiungi riga prodotto
    function addProductRow() {
      const newRow = document.createElement('div');
      newRow.className = 'product-row flex gap-2 items-end p-3 bg-gray-50 rounded-lg';
      newRow.innerHTML = `
        <div class="flex-1">
          <label class="block text-xs text-gray-500 mb-1">Categoria</label>
          <select name="prod_categoria[]" class="prod-categoria w-full border border-gray-300 rounded px-2 py-1.5 text-sm">
            <option value="Patch">Patch</option>
            <option value="Tuta">Tuta</option>
            <option value="Maglia">Maglia</option>
          </select>
        </div>
        <div class="flex-[2]">
          <label class="block text-xs text-gray-500 mb-1">Prodotto</label>
          <select name="prod_prodotto[]" class="prod-prodotto w-full border border-gray-300 rounded px-2 py-1.5 text-sm">
            ${data.patch.filter((p: any) => {
              const disp = p.inMagazzino ?? (p.quantitaIniziale - p.venduti);
              return disp > 0;
            }).map((p: any) => {
              const lottoLabel = p.lotto ? ' [' + p.lotto + ']' : '';
              const disp = p.inMagazzino ?? (p.quantitaIniziale - p.venduti);
              return '<option value="' + p.id + '">' + p.prodotto + lottoLabel + ' (' + disp + ' disp. - ' + p.costoUnitario + '€)</option>';
            }).join('')}
          </select>
        </div>
        <div class="w-20">
          <label class="block text-xs text-gray-500 mb-1">Qtà</label>
          <input type="number" name="prod_quantita[]" value="1" min="1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" />
        </div>
        <div class="w-24">
          <label class="block text-xs text-gray-500 mb-1">Prezzo €</label>
          <input type="number" name="prod_totale[]" step="0.01" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" />
        </div>
        <button type="button" class="btn-remove-product p-1.5 text-red-500 hover:bg-red-50 rounded">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      `;

      container.appendChild(newRow);

      // Aggiungi event listeners
      const catSelect = newRow.querySelector('.prod-categoria');
      catSelect?.addEventListener('change', () => updateProductDropdown(newRow));

      const btnRemove = newRow.querySelector('.btn-remove-product');
      btnRemove?.addEventListener('click', () => newRow.remove());
    }

    // Event listener per aggiungere prodotto
    btnAdd.addEventListener('click', addProductRow);

    // Setup iniziale per la prima riga
    const firstRow = container.querySelector('.product-row');
    if (firstRow) {
      const catSelect = firstRow.querySelector('.prod-categoria');
      catSelect?.addEventListener('change', () => updateProductDropdown(firstRow));
      updateProductDropdown(firstRow);
    }
  }

  // Chiudi modal
  function closeModal() {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    editingIndex = -1;
  }

  // Salva elemento
  async function saveItem(e: Event) {
    e.preventDefault();
    const formData = new FormData(editForm as HTMLFormElement);
    const cols = fields[currentTab];

    // Gestione speciale per vendite con prodotti multipli
    if (currentTab === 'vendite' && editingIndex < 0) {
      const data_vendita = formData.get('data') as string;
      const piattaforma = formData.get('piattaforma') as string;
      const cliente = formData.get('cliente') as string;

      const categorie = formData.getAll('prod_categoria[]') as string[];
      const prodotti = formData.getAll('prod_prodotto[]') as string[];
      const quantita = formData.getAll('prod_quantita[]') as string[];
      const totali = formData.getAll('prod_totale[]') as string[];

      if (prodotti.length === 0 || !prodotti[0]) {
        showToast('Seleziona almeno un prodotto', 'error');
        return;
      }

      try {
        for (let i = 0; i < prodotti.length; i++) {
          if (!prodotti[i]) continue;

          // Il valore è l'ID - trova il nome prodotto
          let prodottoNome = prodotti[i];
          let prodottoId = null;
          if (categorie[i] === 'Patch') {
            const patchItem = data.patch.find((p: any) => p.id == prodotti[i]);
            if (patchItem) {
              prodottoNome = patchItem.lotto ? `${patchItem.prodotto} [${patchItem.lotto}]` : patchItem.prodotto;
              prodottoId = patchItem.id;
            }
          } else if (categorie[i] === 'Maglia') {
            const magliaItem = data.maglie.find((m: any) => m.id == prodotti[i]);
            if (magliaItem) {
              prodottoNome = `${magliaItem.maglia} ${magliaItem.stagione}`;
              prodottoId = magliaItem.id;
            }
          } else if (categorie[i] === 'Tuta') {
            const tutaItem = data.tute.find((t: any) => t.id == prodotti[i]);
            if (tutaItem) {
              prodottoNome = `${tutaItem.tipo} ${tutaItem.squadra} ${tutaItem.stagione}`;
              prodottoId = tutaItem.id;
            }
          }

          const vendita = {
            data: data_vendita,
            categoria: categorie[i],
            prodotto: prodottoNome,
            prodotto_id: prodottoId,
            quantita: parseInt(quantita[i]) || 1,
            totale: parseFloat(totali[i]) || 0,
            piattaforma: piattaforma,
            cliente: cliente
          };

          await fetch('/api/data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ collection: 'vendite', item: vendita })
          });
        }

        showToast(`${prodotti.filter(p => p).length} vendite aggiunte con successo`);
        await loadData();
        closeModal();
        return;
      } catch (error) {
        showToast('Errore durante il salvataggio', 'error');
        return;
      }
    }

    const item: any = {};
    const categoriaValue = formData.get('categoria') as string;

    cols.forEach(col => {
      let value: any = formData.get(col.key);
      if (col.type === 'number') {
        value = parseFloat(value as string) || 0;
      }
      // Gestione speciale per product_select nelle vendite
      if (col.type === 'product_select' && currentTab === 'vendite') {
        if (categoriaValue === 'Patch') {
          // Il valore è l'ID della patch, convertiamo in nome
          const patchItem = data.patch.find((p: any) => p.id == value);
          if (patchItem) {
            item['prodotto'] = patchItem.lotto ? `${patchItem.prodotto} [${patchItem.lotto}]` : patchItem.prodotto;
            item['prodotto_id'] = patchItem.id;
          } else {
            item['prodotto'] = value;
          }
        } else if (categoriaValue === 'Maglia') {
          const magliaItem = data.maglie.find((m: any) => m.id == value);
          if (magliaItem) {
            item['prodotto'] = `${magliaItem.maglia} ${magliaItem.stagione}`;
            item['prodotto_id'] = magliaItem.id;
          } else {
            item['prodotto'] = value;
          }
        } else if (categoriaValue === 'Tuta') {
          const tutaItem = data.tute.find((t: any) => t.id == value);
          if (tutaItem) {
            item['prodotto'] = `${tutaItem.tipo} ${tutaItem.squadra} ${tutaItem.stagione}`;
            item['prodotto_id'] = tutaItem.id;
          } else {
            item['prodotto'] = value;
          }
        } else {
          item['prodotto'] = value;
        }
        return;
      }
      // Gestione speciale per patches nelle maglie (checkbox multiple)
      if (col.type === 'patches' || (currentTab === 'maglie' && col.key === 'patches')) {
        const checkboxes = document.querySelectorAll<HTMLInputElement>('input[name="patch_select"]:checked');
        // Salva i nomi con lotto
        value = Array.from(checkboxes).map(cb => cb.getAttribute('data-nome') || cb.value);
        // Salva anche gli ID per tracking
        item['patch_ids'] = Array.from(checkboxes).map(cb => parseInt(cb.value));
      } else if (col.key === 'patches' && typeof value === 'string') {
        value = value.split(',').map(s => s.trim()).filter(s => s);
      }
      // Salta il campo multi_products che viene gestito sopra
      if (col.type === 'multi_products') return;
      item[col.key] = value;
    });

    try {
      if (editingIndex >= 0) {
        await fetch('/api/data', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ collection: currentTab, index: editingIndex, item })
        });
        showToast('Elemento modificato con successo');
      } else {
        await fetch('/api/data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ collection: currentTab, item })
        });
        showToast('Elemento aggiunto con successo');
      }
      await loadData();
      closeModal();
    } catch (error) {
      showToast('Errore durante il salvataggio', 'error');
    }
  }

  // Elimina elemento
  async function deleteItem(index: number) {
    if (!confirm('Sei sicuro di voler eliminare questo elemento?')) return;

    try {
      await fetch('/api/data', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ collection: currentTab, index })
      });
      showToast('Elemento eliminato con successo');
      await loadData();
    } catch (error) {
      showToast('Errore durante l\'eliminazione', 'error');
    }
  }

  // Esporta JSON
  function exportData() {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'magazzino_backup.json';
    a.click();
    URL.revokeObjectURL(url);
    showToast('JSON esportato con successo');
  }

  // Importa JSON
  async function importData(file: File) {
    try {
      const text = await file.text();
      const importedData = JSON.parse(text);

      // Sovrascrive ogni collezione
      for (const collection of Object.keys(fields)) {
        if (importedData[collection]) {
          data[collection] = importedData[collection];
        }
      }

      // Salva sul server
      for (const collection of Object.keys(fields)) {
        if (importedData[collection]) {
          // Elimina tutti e aggiungi nuovi
          while (data[collection].length > 0) {
            await fetch('/api/data', {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ collection, index: 0 })
            });
            data[collection].shift();
          }
          for (const item of importedData[collection]) {
            await fetch('/api/data', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ collection, item })
            });
          }
        }
      }

      await loadData();
      showToast('JSON importato con successo');
    } catch (error) {
      showToast('Errore durante l\'importazione', 'error');
    }
  }

  // Event listeners
  const searchInput = document.getElementById('search-input') as HTMLInputElement;

  // Filtro ricerca live
  searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase().trim();
    const rows = document.querySelectorAll('.data-row');

    rows.forEach(row => {
      const name = row.getAttribute('data-name') || '';
      if (query === '' || name.includes(query)) {
        (row as HTMLElement).style.display = '';
      } else {
        (row as HTMLElement).style.display = 'none';
      }
    });
  });

  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.setAttribute('data-active', 'false'));
      btn.setAttribute('data-active', 'true');
      currentTab = btn.getAttribute('data-tab')!;
      sectionTitle.textContent = btn.textContent!.trim();
      searchInput.value = ''; // Reset filtro quando cambi tab
      renderTable();
    });
  });

  document.getElementById('btn-add')!.addEventListener('click', () => openModal());
  document.getElementById('btn-close-modal')!.addEventListener('click', closeModal);
  document.getElementById('btn-cancel')!.addEventListener('click', closeModal);
  editForm.addEventListener('submit', saveItem);
  document.getElementById('btn-export')!.addEventListener('click', exportData);
  document.getElementById('import-file')!.addEventListener('change', (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (file) importData(file);
  });

  // Chiudi modal cliccando fuori
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  // Inizializza
  loadData();
</script>
</Layout>
