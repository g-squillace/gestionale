---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';
import { Shirt, Package, ShoppingBag, Search } from 'lucide-astro';

const { data: maglie } = await supabase.from('maglie').select('*');
const maglieData = maglie || [];

const formatEuro = (n: number) => n.toFixed(2).replace('.', ',') + 'â‚¬';

const getStatoBadge = (stato: string) => {
  switch (stato) {
    case 'Venduta': return 'bg-green-100 text-green-700';
    case 'In magazzino': return 'bg-blue-100 text-blue-700';
    case 'Da fare': return 'bg-orange-100 text-orange-700';
    case 'Da arrivare': return 'bg-yellow-100 text-yellow-700';
    default: return 'bg-gray-100 text-gray-700';
  }
};

// Ordinamento: In magazzino prima, Venduta in fondo
const statoOrder: Record<string, number> = {
  'Da preparare': 1,
  'Da arrivare': 2,
  'In magazzino': 3,
  'Venduta': 4
};

const sortedData = [...maglieData].sort((a, b) => {
  return (statoOrder[a.stato] || 5) - (statoOrder[b.stato] || 5);
});

const inMagazzino = maglieData.filter(m => m.stato === 'In magazzino').length;
const vendute = maglieData.filter(m => m.stato === 'Venduta').length;
const totaleInvestimento = maglieData.reduce((acc, m) => acc + m.costo_totale, 0);
const totaleProfitto = maglieData.reduce((acc, m) => acc + m.profitto, 0);
---

<Layout title="Maglie">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
      <Shirt class="w-6 h-6 text-amber-600" />
      Inventario Maglie
    </h1>
    <div class="flex gap-3 text-sm">
      <div class="bg-blue-50 text-blue-700 px-3 py-1.5 rounded-lg flex items-center gap-2">
        <Package class="w-4 h-4" />
        <span class="font-semibold">{inMagazzino}</span>
      </div>
      <div class="bg-green-50 text-green-700 px-3 py-1.5 rounded-lg flex items-center gap-2">
        <ShoppingBag class="w-4 h-4" />
        <span class="font-semibold">{vendute}</span>
      </div>
    </div>
  </div>

  <!-- Filtro ricerca -->
  <div class="mb-4">
    <div class="relative max-w-md">
      <Search class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />
      <input
        type="text"
        id="search-input"
        placeholder="Cerca per nome..."
        class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
      />
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <table class="w-full">
      <thead class="bg-slate-50 border-b border-slate-200">
        <tr class="text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
          <th class="px-4 py-3">Maglia</th>
          <th class="px-4 py-3">Stagione</th>
          <th class="px-4 py-3">Patch</th>
          <th class="px-4 py-3 text-right">Costo Maglia</th>
          <th class="px-4 py-3 text-right">Costo Patch</th>
          <th class="px-4 py-3 text-right">Costo Totale</th>
          <th class="px-4 py-3 text-right">Prezzo Vendita</th>
          <th class="px-4 py-3 text-right">Profitto</th>
          <th class="px-4 py-3 text-center">Stato</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        {sortedData.map((m) => (
          <tr class="hover:bg-slate-50 transition-colors data-row" data-name={m.maglia.toLowerCase()}>
            <td class="px-4 py-3">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-amber-100 rounded flex items-center justify-center">
                  <Shirt class="w-4 h-4 text-amber-500" />
                </div>
                <span class="font-medium text-slate-800">{m.maglia}</span>
              </div>
            </td>
            <td class="px-4 py-3 text-slate-600 text-sm">{m.stagione || '-'}</td>
            <td class="px-4 py-3">
              {m.patches && m.patches.length > 0 ? (
                <div class="flex flex-wrap gap-1">
                  {m.patches.map((patch: string) => (
                    <span class="px-1.5 py-0.5 bg-blue-50 text-blue-700 text-xs rounded">{patch}</span>
                  ))}
                </div>
              ) : (
                <span class="text-gray-400 text-sm">-</span>
              )}
            </td>
            <td class="px-4 py-3 text-right text-slate-600 text-sm">{formatEuro(m.costo_maglia)}</td>
            <td class="px-4 py-3 text-right text-slate-600 text-sm">{formatEuro(m.costo_patch)}</td>
            <td class="px-4 py-3 text-right text-slate-700 font-medium">{formatEuro(m.costo_totale)}</td>
            <td class="px-4 py-3 text-right">
              {m.prezzo_vendita > 0 ? (
                <span class="text-green-600 font-medium">{formatEuro(m.prezzo_vendita)}</span>
              ) : (
                <span class="text-gray-400">-</span>
              )}
            </td>
            <td class="px-4 py-3 text-right">
              <span class={`font-semibold ${m.profitto >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                {formatEuro(m.profitto)}
              </span>
            </td>
            <td class="px-4 py-3 text-center">
              <span class={`px-2 py-1 rounded-full text-xs font-medium ${getStatoBadge(m.stato)}`}>
                {m.stato}
              </span>
            </td>
          </tr>
        ))}
      </tbody>
      <tfoot class="bg-slate-50 border-t-2 border-slate-200">
        <tr class="font-semibold text-slate-700">
          <td class="px-4 py-3" colspan="3">Totale ({maglieData.length} maglie)</td>
          <td class="px-4 py-3 text-right">{formatEuro(maglieData.reduce((acc, m) => acc + m.costo_maglia, 0))}</td>
          <td class="px-4 py-3 text-right">{formatEuro(maglieData.reduce((acc, m) => acc + m.costo_patch, 0))}</td>
          <td class="px-4 py-3 text-right">{formatEuro(totaleInvestimento)}</td>
          <td class="px-4 py-3 text-right text-green-600">{formatEuro(maglieData.filter(m => m.stato === 'Venduta').reduce((acc, m) => acc + m.prezzo_vendita, 0))}</td>
          <td class="px-4 py-3 text-right">
            <span class={totaleProfitto >= 0 ? 'text-green-600' : 'text-red-600'}>
              {formatEuro(totaleProfitto)}
            </span>
          </td>
          <td class="px-4 py-3"></td>
        </tr>
      </tfoot>
    </table>
  </div>
</Layout>

<script>
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const rows = document.querySelectorAll('.data-row');

  searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase().trim();

    rows.forEach(row => {
      const name = row.getAttribute('data-name') || '';
      if (query === '' || name.includes(query)) {
        (row as HTMLElement).style.display = '';
      } else {
        (row as HTMLElement).style.display = 'none';
      }
    });
  });
</script>
